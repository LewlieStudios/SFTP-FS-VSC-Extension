<!--
  HTML template for the Connections View (connections.view.ts).
  This file is loaded into a WebView and communicates with the extension via the VS Code API.

  Some special placeholders are used in this file, that are replaced when the HTML is loaded:
  - %%CSP%% => String containing the Content Security Policy.
  - %%VSCODE_ELEMENTS_SCRIPT_PATH%% => Path to the `bundled.js` script from `@vscode-elements/elements` package.
  - %%VSCODE_CODICONS_STYLE_PATH%% => Path to the `codicons.css` stylesheet from `@vscode/codicons` package.
  - %%NONCE%% => Nonce string to be used in script tags for CSP compliance.

  The rest are handled by the VS Code API.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="%%CSP%%">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Connections</title>
  <script type="module" src="%%VSCODE_ELEMENTS_SCRIPT_PATH%%" nonce="%%NONCE%%"></script>
  <link rel="stylesheet" href="%%VSCODE_CODICONS_STYLE_PATH%%" id="vscode-codicon-stylesheet">
  <style>
    :root {
      color-scheme: light dark;
    }
    
    body {
      margin: 0;
      padding: 16px;
      font-family: var(--vscode-font-family);
      color: var(--vscode-foreground);
      background: var(--vscode-sideBar-background);
    }
    
    h1,
    p {
      margin: 0;
      line-height: 1.4;
    }
    
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .toolbar__details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .toolbar__title {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    
    .toolbar__subtitle {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }
    
    .connections {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .connections__header {
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-sideBarSectionHeader-foreground, var(--vscode-foreground));
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    
    .connections-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .connection-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--vscode-list-inactiveSelectionBackground);
      border: 1px solid var(--vscode-sideBarSectionHeader-border, transparent);
      transition: background 120ms ease, border-color 120ms ease;
    }
    
    @media (max-width: 320px) {
      .connection-item__icon {
        display: none;
      }
    }
    
    @media (max-width: 260px) {
      .connection-item {
        display: block;
      }
      
      .connection-item__actions {
        margin-top: 12px;
      }
    }
    
    .connection-item:hover {
      background: var(--vscode-list-hoverBackground);
      border-color: var(--vscode-focusBorder);
    }
    
    .connection-item__icon vscode-icon {
      width: 20px;
      height: 20px;
    }
    
    .connection-item__body {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }
    
    .connection-item__name {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .connection-item__meta {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .connection-item__actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    vscode-button[appearance='icon'] {
      min-width: auto;
    }
    
    .toolbar-actions {
      margin-bottom: 16px;
    }
    
    .connection-item__badge {
      margin-top: 4px;
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: 600;
      border-radius: 5px;
      color: var(--vscode-button-foreground);
    }
    
    .badge-active {
      background-color: #4CAF50;
      margin-right: 3px;
    }
    
    .badge-inactive {
      background-color: #4b4b4bff;
      margin-right: 3px;
    }
    
    .badge-connections {
      background-color: var(--vscode-button-background);
    }
  </style>
</head>
<body>
  <section class="connections">
    <span class="connections__header">Configured Remote Connections</span>
    <vscode-button icon="add" appearance="primary" id="add-connection-button">Add...</vscode-button>
    <vscode-button icon="trash" appearance="primary" id="remove-connection-button">Remove...</vscode-button>
    <div class="connections-list" id="connections-list">
      <!-- EXAMPLE
      <article class="connection-item">
        <span class="connection-item__icon">
          <vscode-icon name="plug"></vscode-icon>
        </span>
        <div class="connection-item__body">
          <span class="connection-item__name">Connection 1</span>
          <span class="connection-item__meta">example.com.asd.asd.as.dsa.</span>
          <div>
            <span class="connection-item__badge badge-disconnected">Not Connected</span>
          </div>
        </div>
        <div class="connection-item__actions">
          <vscode-button appearance="icon" aria-label="Connect" title="Connect" icon="plug"></vscode-button>
          <vscode-button appearance="icon" aria-label="Edit" title="Edit" icon="edit"></vscode-button>
          <vscode-button appearance="icon" aria-label="Edit" title="Open Local Folder" icon="folder"></vscode-button>
        </div>
      </article>
      -->
    </div>
  </section>
  <script nonce="%%NONCE%%">
    const vscode = acquireVsCodeApi();
    let connections = [];
    let firstLoad = true;
    
    vscode.postMessage({ command: 'connections.list' });

    const getHtmlContent = (connection, connectIcon, connectTitle, connectLabel) => {
      return `
        <span class="connection-item__icon">
          <vscode-icon name="plug"></vscode-icon>
        </span>
        <div class="connection-item__body">
          <span class="connection-item__name">${connection.remoteName}</span>
          <span class="connection-item__meta">${connection.host}</span>
          <div>
            <span class="connection-item__badge badge-${connection.status}">${connection.displayStatus}</span>
            <span class="connection-item__badge badge-connections">${connection.totalConnections} connections</span>
          </div>
        </div>
        <div class="connection-item__actions">
          <vscode-button appearance="icon" aria-label="${connectLabel}" title="${connectTitle}" icon="${connectIcon}" data-action="connect" data-remote-name="${connection.remoteName}"></vscode-button>
          <vscode-button appearance="icon" aria-label="Edit" title="Edit" icon="edit" data-action="edit" data-remote-name="${connection.remoteName}" ${connection.status === 'inactive' ? '' : 'disabled'}></vscode-button>
          <vscode-button appearance="icon" aria-label="Open Local Folder" title="Open Local Folder" icon="folder" data-action="open-folder" data-remote-name="${connection.remoteName}" ${connection.localFolderConfigured ? '' : 'disabled'}></vscode-button>
        </div>
      `;
    };

    const attachConnectionEventListeners = (article, connection) => {
      const connectButton = article.querySelector('[data-action="connect"]');
      if (connectButton) {
        connectButton.addEventListener('click', () => {
          vscode.postMessage({ command: 'connections.connect', data: connection.remoteName });
        });
      }

      const editButton = article.querySelector('[data-action="edit"]');
      if (editButton) {
        editButton.addEventListener('click', () => {
          vscode.postMessage({ command: 'connections.edit', data: connection.remoteName });
        });
      }

      const openFolderButton = article.querySelector('[data-action="open-folder"]');
      if (openFolderButton) {
        openFolderButton.addEventListener('click', () => {
          vscode.postMessage({ command: 'connections.openFolder', data: connection.remoteName });
        });
      }
    };
    
    window.addEventListener('message', (event) => {
      const message = event.data;
      if (!message?.command) {
        return;
      }
      
      if (message.command === 'connections.provide-list') {
        connections = message.data;
        console.log('Received connections:', connections);

        const connectionsList = document.getElementById('connections-list');

        if (firstLoad) {
          // On first load, we just populate the list from scratch
          firstLoad = false;
        
          connections.forEach((connection) => {
            const isActive = connection.status === 'active';
            const connectIcon = isActive ? 'debug-disconnect' : 'plug';
            const connectTitle = isActive ? 'Disconnect' : 'Connect';
            const connectLabel = isActive ? 'Disconnect' : 'Connect';

            const article = document.createElement('article');
            article.className = 'connection-item';
            article.setAttribute('data-remote-name', connection.remoteName);
            article.innerHTML = getHtmlContent(connection, connectIcon, connectTitle, connectLabel);

            connectionsList.appendChild(article);

            // Additional event listeners for connect, edit, delete buttons
            console.log('Adding event listeners for connection:', connection.remoteName);

            attachConnectionEventListeners(article, connection);
          });
        } else {
          // On subsequent updates, we update the existing items
          connections.forEach((connection) => {
            const existingItem = connectionsList.querySelector(`.connection-item[data-remote-name="${connection.remoteName}"]`);
            if (existingItem) {
              // Update existing item
              existingItem.querySelector('.connection-item__meta').textContent = connection.host;
              existingItem.querySelector('.badge-active, .badge-inactive').textContent = connection.displayStatus;
              existingItem.querySelector('.badge-active, .badge-inactive').className = `connection-item__badge badge-${connection.status}`;
              existingItem.querySelector('.badge-connections').textContent = `${connection.totalConnections} connections`;

              const connectButton = existingItem.querySelector('[data-action="connect"]');
              const isActive = connection.status === 'active';
              if (connectButton) {
                connectButton.setAttribute('icon', isActive ? 'debug-disconnect' : 'plug');
                connectButton.setAttribute('title', isActive ? 'Disconnect' : 'Connect');
                connectButton.setAttribute('aria-label', isActive ? 'Disconnect' : 'Connect');
                connectButton.setAttribute('data-remote-name', connection.remoteName);
              }

              const editButton = existingItem.querySelector('[data-action="edit"]');
              if (editButton) {
                editButton.setAttribute('data-remote-name', connection.remoteName);
                if (connection.status === 'inactive') {
                  editButton.removeAttribute('disabled');
                } else {
                  editButton.setAttribute('disabled', '');
                }
              }

              const openFolderButton = existingItem.querySelector('[data-action="open-folder"]');
              if (openFolderButton) {
                openFolderButton.setAttribute('data-remote-name', connection.remoteName);
                if (connection.localFolderConfigured) {
                  openFolderButton.removeAttribute('disabled');
                } else {
                  openFolderButton.setAttribute('disabled', '');
                }
              }
            } else {
              // New connection added, create new item
              const isActive = connection.status === 'active';
              const connectIcon = isActive ? 'debug-disconnect' : 'plug';
              const connectTitle = isActive ? 'Disconnect' : 'Connect';
              const connectLabel = isActive ? 'Disconnect' : 'Connect';

              const article = document.createElement('article');
              article.className = 'connection-item';
              article.setAttribute('data-remote-name', connection.remoteName);
              article.innerHTML = getHtmlContent(connection, connectIcon, connectTitle, connectLabel);

              connectionsList.appendChild(article);

              // Additional event listeners for connect, edit, delete buttons
              console.log('Adding event listeners for connection:', connection.remoteName);

              attachConnectionEventListeners(article, connection);
            }
          });

          // Remove items that are no longer present
          const currentRemoteNames = connections.map(c => c.remoteName);
          console.log('Current remote names:', currentRemoteNames);
          const itemsToRemove = connectionsList.querySelectorAll('.connection-item');
          itemsToRemove.forEach(item => {
            const remoteName = item.getAttribute('data-remote-name');
            console.log('Checking remote name:', remoteName);
            if (!currentRemoteNames.includes(remoteName)) {
              console.log('Removing connection item for remote name:', remoteName);
              connectionsList.removeChild(item);
            } else {
              console.log('Keeping connection item for remote name:', remoteName);
            }
          });
        }
      }
    });
    
    document.getElementById('add-connection-button').addEventListener('click', () => {
      vscode.postMessage({ command: 'connections.add' });
    });
    
    document.getElementById('remove-connection-button').addEventListener('click', () => {
      vscode.postMessage({ command: 'connections.delete' });
    });
  </script>
</body>
